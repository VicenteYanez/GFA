{% extends "base.html" %}

{% block body %}
<div class="row">
    <div id="colorbar-legend-container" class="seven columns">
      <div id="map" class="map">
        <pre id="info"/>
        <script type="text/javascript">
      // default zoom, center and rotation
        var zoom = 4;
        var center = ol.proj.fromLonLat([-70.0, -39.0]);
        var rotation = 0;

        if (window.location.hash !== '') {
          // try to restore center, zoom-level and rotation from the URL
          var hash = window.location.hash.replace('#map=', '');
          var parts = hash.split('/');
          if (parts.length === 4) {
            zoom = parseInt(parts[0], 10);
            center = [
              parseFloat(parts[1]),
              parseFloat(parts[2])
            ];
            rotation = parseFloat(parts[3]);
          }
        }

        // station points
        var fill = new ol.style.Fill({color: 'black'});
        var styles = {
         'square': new ol.style.Style({
           image: new ol.style.RegularShape({
             fill: fill,
             points: 4,
             radius: 5,
             angle: Math.PI / 4
           })
         }),
        }
        var coordinates = [{% for i in latlon %}
          [ {{i[0]}}, {{i[1]}} ],
          {% endfor %}];
        count = coordinates.length;
        var features = new Array(count);
        for (var i = 0; i < count; ++i) {
          features[i] = new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat(coordinates[i])));
          features[i].setStyle(styles['square']);
        }
        var source = new ol.source.Vector({
          features: features
        });

        var vectorLayer = new ol.layer.Vector({
          source: source
        });

        var map = new ol.Map({
          target: 'map',
          layers: [
            new ol.layer.Tile({
              source: new ol.source.OSM()
            }),
            vectorLayer
          ],
          controls: ol.control.defaults({
            attributionOptions: /** @type {olx.control.AttributionOptions} */ ({
              collapsible: false
            })
          }),
          view: new ol.View({
            center: center,
            zoom: zoom,
            rotation: rotation
          })
        });

        var shouldUpdate = true;
        var view = map.getView();
        var updatePermalink = function() {
          if (!shouldUpdate) {
            // do not update the URL when the view was changed in the 'popstate' handler
            shouldUpdate = true;
            return;
          }

          var center = view.getCenter();
          var hash = '#map=' +
              view.getZoom() + '/' +
              Math.round(center[0] * 100) / 100 + '/' +
              Math.round(center[1] * 100) / 100 + '/' +
              view.getRotation();
          var state = {
            zoom: view.getZoom(),
            center: view.getCenter(),
            rotation: view.getRotation()
          };
          window.history.pushState(state, 'map', hash);
        };

        map.on('moveend', updatePermalink);

        // Create the graticule component
        var graticule = new ol.Graticule({
          // the style to use for the lines, optional.
          strokeStyle: new ol.style.Stroke({
            color: 'rgba(0,0,0,0.5)',
            width: 1,
            lineDash: [0.5, 4]
          }),
          showLabels: true
        });

        // vorticity geojson
        function lineStyleFunction(feature, resolution) {
          var scaleForPixelDensity = 0.1; //dpi_x/96.0;
          var lineWidth = feature.get('stroke-width') * scaleForPixelDensity * Math.pow(map.getView().getZoom()/2.0, 1.3);
          var lineStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: feature.get('stroke'),
              width: lineWidth,
              opacity: 0.0 //feature.get('opacity')
              //            width: climateMap.getView().getZoom(),
            })
          });
          return lineStyle;
        }

        var urlgeojson = "{{url_for('mapdata')}}?date={{ herenow }}";
        var vorticitylayer = new ol.layer.Vector({
          source: new ol.source.Vector({
            url: urlgeojson,
            format: new ol.format.GeoJSON()
          }),
          style: lineStyleFunction
        });
        map.addLayer(vorticitylayer);

        // colorbar code
        var colorbarLegend = (function() {
          return Object.freeze({
            update: function() {
              var colorBarImage = document.getElementById('colorbar-legend-container');
              var imageUrl = "{{url_for('colorbar')}}?date={{ herenow }}";
              colorBarImage.style.backgroundImage = 'url(' + imageUrl + ')';
            }
          });
        }) ();

        //feature info
        map.on('pointermove', showInfo);

        var info = document.getElementById('info');
        function showInfo(event) {
          var myfeatures = map.getFeaturesAtPixel(event.pixel);
          if (!myfeatures) {
            info.innerText = '';
            info.style.opacity = 0;
            return;
          }
          var properties = myfeatures[0].getProperties();
          info.innerText = JSON.stringify(myfeatures, null, 2);
          info.style.opacity = 1;
        }

        // restore the view state when navigating through the history, see
        // https://developer.mozilla.org/en-US/docs/Web/API/WindowEventHandlers/onpopstate
        window.addEventListener('popstate', function(event) {
          if (event.state === null) {
            return;
          }
          map.getView().setCenter(event.state.center);
          map.getView().setZoom(event.state.zoom);
          map.getView().setRotation(event.state.rotation);
          shouldUpdate = false;
        });

        graticule.setMap(map);
      </script>
      </div>
    </div>
    <div class="five columns">
      <div class="tabbar">
         <button class="tabbar-button" onclick="openTab('GNSS', 'tabs1')">GNSS</button>
         <button class="tabbar-button" onclick="openTab('FieldAnalysis', 'tabs1')">Field Analysis</button>
         <hr>
      </div>
      <div id="GNSS" class="tabs1">
      <form action="{{url_for('homepage')}}", method="post">
        <p>Only 2d field analysis for now</p>
        <h4>Latitude</h4>
        <label for="latmin">Minimum</label>
        <input type="number" name="latmin" min="-90" max="90" step="0.1" placeholder="latmin" value="-45">
        <label for="latmax">Maximum</label>
        <input type="number" name="latmax" min="-90" max="90" step="0.1" placeholder="latmax" value="-35">
        <h4>Longitude</h4>
        <label for="lonmin">Minimum</label>
        <input type="number" min="-180" max="180" step="0.1" placeholder="lonmin" name="lonmin" value="-76">
        <label for="lonmax">Maximum</label>
        <input type="number" min="-180" max="180" step="0.1" placeholder="lonmax" name="lonmax" value="-64">
        <h4>Time range (yyyy-mm-dd)</h4>
        <label for="inicial">Start</label>
        <input type="text" placeholder="t_inicial" name="t_inicial" value="2005-01-01">
        <label for="final">End</label>
        <input type="text" placeholder="t_final" name="t_final" value="2016-12-31">
        <label>
          <input type="checkbox">
          <span class="label-body">Add trajectory model(it doesn't work)</span>
        </label>
        <input class="button-primary" name="btn_select" value="Select" type="submit">
      </form>
      </div>
      <div id="FieldAnalysis" class="tabs1" style="display:none">
        <form action="{{url_for('field')}}", method="post">
          <h4>Latitude</h4>
          <label for="latmin">Minimum</label>
          <input type="number" name="latmin" min="-90" max="90" step="0.1" placeholder="latmin" value="-45">
          <label for="latmax">Maximum</label>
          <input type="number" name="latmax" min="-90" max="90" step="0.1" placeholder="latmax" value="-35">
          <h4>Longitude</h4>
          <label for="lonmin">Minimum</label>
          <input type="number" min="-180" max="180" step="0.1" placeholder="lonmin" name="lonmin" value="-76">
          <label for="lonmax">Maximum</label>
          <input type="number" min="-180" max="180" step="0.1" placeholder="lonmax" name="lonmax" value="-64">
          <h4>Time range (yyyy-mm-dd)</h4>
          <label for="inicial">Start</label>
          <input type="text" placeholder="t_inicial" name="t_inicial" value="2005-01-01">
          <label for="final">End</label>
          <input type="text" placeholder="t_final" name="t_final" value="2016-12-31">
          <h4>Metodology</h4>
          <input type="radio" name="metodology" value="interpol"> Vector interpolation(not implemented yet)
          <br />
          <input type="radio" name="metodology" value="cardozo"> Cardozo & Allmendinger matrix(default)
          <br />
          <input type="number" name="grid" value="1000" max="100000" min="100"> Grid density(100000 - 100)
          <br />
          <input type="number" name="alfa" value="10000" max="300000" min="100"> Alfa(300000 - 10000)
          <br />
          <input class="button-primary" name="btn_field" value="Plot" type="submit">
        </form>
      </div>
  </div>
</div>
<br>
<div class="row">
  <div class="ten columns">
    <div class="tabbar">
      <button class="tabbar-button" onclick="openTab('Model', 'tabs2')">Model tools</button>
      <button class="tabbar-button" onclick="openTab('Vectors', 'tabs2')">Vectors</button>
    </div>
  </div>
  <div class="two columns">
    <input class="button-primary" onclick="window.open('download?date={{ herenow }}','_blank')" type="submit" value="Download Data">
  </div>
  <hr>
</div>
  <div id="Model" class="tabs2">
    <table class="u-full-width">
      <thead>
        <tr>
          <th style="width:12%">Station</th>
          <th style="width:10%">Polynomial</th>
          <th style="width:15%">Jumps</th>
          <th style="width:15%">Fourier</th>
          <th style="width:15%">Log start</th>
          <th style="width:15%">Log scale</th>
          <th style="width:10%"></th>
          <th style="width:10%"></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>All the stations</td>
          <td><input style="width:100%" type="text" name="poly_all" value=""></td>
          <td><input style="width:100%" type="text" name="jump_all" value=""></td>
          <td><input style="width:100%" type="text" name="fourier_all" value=""></td>
          <td><input style="width:100%" type="text" name="logstart_all" value=""></td>
          <td><input style="width:100%" type="text" name="logscale_all" value=""></td>
          <td><button onclick="">Edit All</button></td>
        </tr>
        {% for station in stations %}
        <tr>
          <form action="edit/{{ station[0] }}", method="post">
          <td>{{ station[0] }}<br>Lon: {{ station[1] }}ยบ<br>Lat: {{ station[2] }}ยบ</td>
          <td><input style="width:100%" type="text" name="poly" value="{{ station[3] }}"></td>
          <td><input style="width:100%" type="text" name="jump" value="{{ station[4] }}"></td>
          <td><input style="width:100%" type="text" name="fourier" value="{{ station[5] }}"></td>
          <td><input style="wid th:100%" type="text" name="logstart" value="{{ station[6] }}"></td>
          <td><input style="width:100%" type="text" name="logscale" value="{{ station[7] }}"></td>
          <td><input class="button-primary" name="edit" value="Edit" type="submit"></td>
          </form>
          <td><input class="button-primary" value="Plot" onclick="window.open('plot/{{ station[0] }}?date={{ herenow }}','_blank')" type="submit"></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div id="Vectors" class="tabs2" style="display:none">
    <div class="twelve columns">
    <table>
      <thead>
        <tr>
          <th style="width:15%">Stations</th>
          <th style="width:25%">Velocity(mm/year)<br>East, Norh and Vertical </th>
          <th style="width:25%">Start<br>yyyy-mm-dd</th>
          <th style="width:25%">End<br>yyyy-mm-dd</th>
          <th style="width:10%"></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>All the stations</td>
          <td></td>
          <td><input style="width:100%" type="text" name="start_all" value=""></td>
          <td><input style="width:100%" type="text" name="end_all" value=""></td>
          <td><button style="width:100%" onclick="">Edit All</button></td>
        </tr>
        {% for station in vectors %}
        <tr>
          <form action="{{url_for('calc_vector')}}", method="post">
          <td>{{ station[0] }}<br>Lon: {{ station[1] }}ยบ<br>Lat: {{ station[2] }}ยบ<input type="hidden" name="stationname" value="{{ station[0]}}"></td>
          <td>Ve: {{ station[8] }} <br>Vn: {{ station[9] }} <br> Vz:{{ station[10] }} </td>
          <td><input style="width:100%" type="text" name="t1" value="{{ station[11] }}"></td>
          <td><input style="width:100%" type="text" name="t2" value="{{ station[12] }}"></td>
          <td><input style="width:100%" class="button-primary" name="btn_vector" value="Calculate" type="submit">
          </form><input style="width:100%" class="button-primary" value="Plot" onclick="window.open('plot-v/{{ station[0] }}?date={{ herenow }}','_blank')" type="submit"></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  </div>
</div>

{% endblock %}
